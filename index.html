<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Study Navigator</title>

        <!-- Open Graph / Twitter Card
            NOTE: For milestone-specific images, we use /share/*.html pages that point to assets/og/*.png.
        -->
        <meta property="og:locale" content="ja_JP">
        <meta property="og:type" content="website">
        <meta property="og:title" content="AWS Study Navigator">
        <meta property="og:description" content="AWS認定の学習を、XPと称号で積み上げる学習ナビ。">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1f2937;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .aws-gradient {
            background: linear-gradient(135deg, #232f3e 0%, #374151 100%);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 700px;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* AI modal markdown rendering */
        .ai-response-area {
            line-height: 1.7;
            white-space: normal;
        }
        .ai-response-area h1, .ai-response-area h2, .ai-response-area h3 {
            font-weight: 700;
            color: #111827;
            margin: 0.75rem 0 0.5rem;
        }
        .ai-response-area h1 { font-size: 1.25rem; }
        .ai-response-area h2 { font-size: 1.125rem; }
        .ai-response-area h3 { font-size: 1rem; }
        .ai-response-area p { margin: 0.5rem 0; }
        .ai-response-area ul, .ai-response-area ol {
            margin: 0.5rem 0 0.75rem 1.25rem;
            padding: 0;
        }
        .ai-response-area li { margin: 0.25rem 0; }
        .ai-response-area a { color: #1d4ed8; text-decoration: underline; }
        .ai-response-area hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 0.75rem 0;
        }
        .ai-response-area blockquote {
            margin: 0.75rem 0;
            padding: 0.5rem 0.75rem;
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
            color: #92400e;
            border-radius: 8px;
        }
        .ai-response-area code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.95em;
            background: #f3f4f6;
            padding: 0.1rem 0.3rem;
            border-radius: 6px;
        }
        .ai-response-area pre {
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: #111827;
            color: #e5e7eb;
            border-radius: 10px;
            overflow: auto;
        }
        .ai-response-area pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .sparkle-btn {
            background: linear-gradient(90deg, #6366f1, #a855f7);
            background-size: 200% 200%;
            animation: gradientBG 3s ease infinite;
        }

        /* Recommended resource card ("おススメ") */
        .recommend-card {
            position: relative;
            overflow: hidden;
            border-color: #fdba74; /* orange-300 */
            background: linear-gradient(135deg, rgba(255, 237, 213, 0.95), rgba(255, 255, 255, 0.95), rgba(254, 215, 170, 0.95));
            background-size: 240% 240%;
            animation: gradientBG 5s ease infinite;
        }

        /* subtle shimmer */
        .recommend-card::before {
            content: "";
            position: absolute;
            inset: -40% -60%;
            background: linear-gradient(120deg, transparent 35%, rgba(255, 255, 255, 0.55) 50%, transparent 65%);
            transform: translateX(-30%) rotate(8deg);
            animation: recommendShimmer 2.8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes recommendShimmer {
            0% { transform: translateX(-55%) rotate(8deg); opacity: 0.0; }
            35% { opacity: 0.35; }
            60% { opacity: 0.12; }
            100% { transform: translateX(35%) rotate(8deg); opacity: 0.0; }
        }

        @media (prefers-reduced-motion: reduce) {
            .recommend-card { animation: none; }
            .recommend-card::before { animation: none; display: none; }
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HGYPRYH7Q1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-HGYPRYH7Q1');
</script>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="aws-gradient text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 id="siteTitle" class="text-2xl md:text-3xl font-bold tracking-tight">AWS Study Navigator</h1>
                    <p id="siteSubtitle" class="text-gray-300 mt-2 text-sm md:text-base">
                        <a data-xp-link="resource" href="https://d1.awsstatic.com/ja_JP/training-and-certification/docs-advnetworking-spec/AWS-Certified-Advanced-Networking-Specialty_Exam-Guide.pdf" target="_blank" rel="noopener noreferrer" class="underline decoration-gray-500 hover:decoration-gray-200 hover:text-white transition-colors">試験ガイド</a>に基づく学習リソースナビゲーター
                    </p>
                </div>

                <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                    <div class="flex gap-3 items-center">
                        <div class="relative">
                            <button id="examMenuBtn" type="button" class="bg-gray-700 bg-opacity-50 hover:bg-gray-600 rounded-lg px-4 py-2 text-center transition" title="試験を切り替え">
                                <span class="block text-xs text-gray-400">Exam</span>
                                <span class="font-mono font-bold inline-flex items-center gap-2">
                                    <span id="examCodeBadge">ANS-C01</span>
                                    <i class="fas fa-chevron-down text-xs text-gray-300"></i>
                                </span>
                            </button>
                            <div id="examMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden z-50">
                                <div class="px-3 py-2 text-xs text-gray-500 bg-gray-50 border-b">試験を選択</div>
                                <div id="examSwitcher" class="p-2 flex flex-wrap gap-2" aria-label="Exam Switcher"></div>
                            </div>
                        </div>

                        <button id="settingsBtn" type="button" class="bg-gray-700 bg-opacity-50 hover:bg-gray-600 rounded-lg px-4 py-2 text-center transition flex flex-col items-center justify-center group" title="API Key Settings">
                            <span class="block text-xs text-gray-400 group-hover:text-white">API Key</span>
                            <i class="fas fa-cog text-gray-300 group-hover:text-white"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="flex-grow container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- Left Sidebar: Domain Weights & Navigation -->
        <aside class="lg:col-span-4 xl:col-span-3 space-y-6">
            <!-- Domain Weight Chart -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">ドメイン別出題比率</h3>
                <div class="chart-container">
                    <canvas id="examWeightChart"></canvas>
                </div>
                <div id="domainLegend" class="mt-4 space-y-2 text-sm">
                    <!-- Dynamic Legend -->
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-2">学習フロー</h3>
                <div class="space-y-3">
                    <div class="flex items-center text-sm text-gray-700">
                        <i class="fas fa-book-open w-6 text-orange-500"></i>
                        <span>
                            <a data-xp-link="resource" href="https://d1.awsstatic.com/ja_JP/training-and-certification/docs-advnetworking-spec/AWS-Certified-Advanced-Networking-Specialty_Exam-Guide.pdf" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 underline">試験ガイド</a>を確認する
                        </span>

                    </div>
                    <div class="flex items-center text-sm text-gray-700">
                        <i class="fas fa-link w-6 text-blue-500"></i>
                        <span>AWS公式リソースで理解を深める</span>
                    </div>
                    <div class="flex items-center text-sm text-gray-700">
                        <i class="fas fa-magic w-6 text-purple-500"></i>
                        <span>AI機能を活用する</span>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-blue-50 text-blue-800 text-xs rounded border border-blue-100">
                    <i class="fas fa-info-circle mr-1"></i>
                    AI機能を使用するには、右上の設定ボタン(⚙️)からGemini APIキーを設定してください。
                </div>

                <div class="mt-4 p-3 bg-gray-50 text-gray-700 text-xs rounded border border-gray-200">
                    <i class="fas fa-comment-dots mr-1 text-gray-500"></i>
                    追加してほしい学習リソースがあれば、GitHub で Issues を作成してください。
                </div>
            </div>
        </aside>

        <!-- Right Content: Domain Explorer -->
        <section class="lg:col-span-8 xl:col-span-9 space-y-6">
            
            <!-- Context Header for Right Section -->
            <div id="xpDashboard" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex flex-col md:flex-row md:items-start justify-between gap-4">
                    <div class="min-w-0 flex-1">
                        <h2 class="text-xl font-bold text-gray-900">学習ダッシュボード</h2>
                        <p id="xpUserLine" class="text-gray-600 text-sm mt-1 whitespace-pre-line break-words">
                            学習の総量を積み上げていきましょう。
                        </p>
                    </div>
                    <div class="flex gap-2 justify-end flex-shrink-0">
                        <button id="editUserNameBtn" type="button" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-medium transition flex items-center gap-2 whitespace-nowrap">
                            <i class="fas fa-user-pen"></i> ユーザー名変更
                        </button>
                        <button id="tweetBtn" type="button" class="px-3 py-2 bg-black hover:bg-gray-900 text-white rounded-lg text-sm font-bold transition duration-150 flex items-center gap-2 whitespace-nowrap shadow-sm hover:shadow-md active:shadow-sm active:translate-y-px focus:outline-none focus:ring-2 focus:ring-black/30">
                            Xに投稿
                        </button>
                    </div>
                </div>

                <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
                        <div class="text-xs font-bold text-gray-500 uppercase tracking-wide">これまでの累積 XP</div>
                        <div class="mt-1 flex items-end gap-2">
                            <div id="xpTotal" class="text-3xl font-extrabold text-gray-900 font-mono">0</div>
                            <div class="pb-1 text-sm font-bold text-gray-500 font-mono">(直近7日間 <span id="xpWeek">+0</span>)</div>
                        </div>
                        <div class="mt-3 text-[11px] font-bold text-gray-500 uppercase tracking-wide">直近の獲得</div>
                        <div id="xpRecentActions" class="mt-1 space-y-1 text-xs text-gray-600"></div>
                    </div>

                    <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
                        <div class="flex items-center gap-2">
                            <div class="text-xs font-bold text-gray-500 uppercase tracking-wide">称号</div>
                            <div id="xpTitleBadge" class="text-[11px] font-bold px-2 py-0.5 rounded border bg-white text-gray-800 border-gray-200">-</div>
                        </div>
                        <div class="mt-3 space-y-1 text-xs text-gray-600">
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="whitespace-nowrap">次の称号：</span>
                                <span id="xpNextTitle" class="min-w-0 truncate font-semibold text-gray-800">-</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="whitespace-nowrap">残り：</span>
                                <span id="xpRemaining" class="whitespace-nowrap">0 XP</span>
                            </div>
                        </div>
                        <div class="mt-2 h-2 rounded bg-gray-200 overflow-hidden">
                            <div id="xpProgressBar" class="h-2 bg-orange-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div id="appBootError" class="hidden mt-4 p-3 bg-red-50 text-red-800 text-xs rounded border border-red-200">
                    <i class="fas fa-triangle-exclamation mr-1"></i>
                    画面データの読み込みに失敗しました。ページを再読み込みしてください。
                    ローカルで直接開いている場合は、簡易サーバー経由で開く必要があります。
                </div>
            </div>

            <!-- Domain Tabs -->
            <div class="flex overflow-x-auto space-x-1 border-b border-gray-200 pb-1" id="domainTabs">
                <!-- Tabs injected by JS -->
            </div>

            <!-- Dynamic Content Area -->
            <div id="contentArea" class="space-y-6">
                <!-- Task Cards injected by JS -->
            </div>

        </section>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>&copy; 2024 AWS Study Navigator. Powered by Gemini API.</p>
        </div>
    </footer>

    <!-- AI Modal -->
    <div id="aiModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-robot text-purple-500"></i> <span id="modalTitle">AI Response</span>
                </h3>
                <button type="button" data-close-modal="aiModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="modalLoading" class="hidden flex flex-col items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600 mb-4"></div>
                    <p class="text-gray-500 text-sm animate-pulse">Gemini is thinking...</p>
                </div>
                <div id="modalContent" class="text-gray-700 ai-response-area text-sm md:text-base"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button id="aiRetryBtn" type="button" class="hidden px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i class="fas fa-rotate-right"></i> もう一度
                </button>
                <button type="button" data-close-modal="aiModal" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                    閉じる
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" data-backdrop-close="true">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-cog text-gray-600"></i> 設定
                </h3>
                <button type="button" data-close-modal="settingsModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="apiKeyInput">
                        Google Gemini API Key
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="apiKeyInput" type="password" placeholder="AIzaSy...">
                    <p class="text-gray-500 text-xs mt-2">
                        APIキーはブラウザのローカルストレージにのみ保存され、外部サーバーには送信されません。<br>
                        キーをお持ちでない場合は <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-500 underline">Google AI Studio</a> から取得してください。
                    </p>
                </div>
                <div id="settingsMessage" class="text-sm mb-4 hidden"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button id="resetLocalBtn" type="button" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors mr-auto">
                    データ初期化
                </button>
                <button id="apiKeyClearBtn" type="button" class="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors">
                    削除
                </button>
                <button id="apiKeySaveBtn" type="button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="userModal" class="modal" data-locked="false">
        <div class="modal-content" style="max-width: 520px;">
            <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50 rounded-t-xl">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-user text-gray-700"></i> ユーザー名登録
                </h3>
                <button id="userModalCloseBtn" type="button" data-close-modal="userModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-600 mb-4">
                    学習進捗を保存するため、まずユーザー名を登録してください（この端末のブラウザに保存されます）。
                </p>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="userNameInput">ユーザー名</label>
                    <input id="userNameInput" type="text" maxlength="30" placeholder="例: matsu" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <p class="text-gray-500 text-xs mt-2">後からいつでも変更できます。</p>
                </div>
                <div id="userMessage" class="text-sm mb-4 hidden"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-xl flex justify-end gap-2">
                <button id="userNameSaveBtn" type="button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- Milestone Toast (fixed) -->
    <div id="milestoneToast" class="hidden fixed top-4 right-4 z-[1100] max-w-sm">
        <div class="bg-white border border-orange-200 shadow-lg rounded-xl p-4">
            <div class="flex items-start gap-3">
                <div class="w-9 h-9 rounded-full bg-orange-100 text-orange-700 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="flex-1">
                    <div class="text-sm font-bold text-gray-900">称号を解放しました！</div>
                    <div id="milestoneToastText" class="text-sm text-gray-700 mt-1">-</div>
                </div>
                <button id="milestoneToastCloseBtn" type="button" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    <script type="module" src="./js/app.js"></script>
    <script>
        // If the module app doesn't boot, show a helpful message.
        setTimeout(() => {
            if (!window.__APP_READY__) {
                const el = document.getElementById('appBootError');
                if (!el) return;
                const err = window.__APP_BOOT_ERROR__;
                if (err) {
                    const msg = err && (err.stack || err.message || String(err));
                    el.innerHTML = `<i class="fas fa-triangle-exclamation mr-1"></i>
                        画面データの読み込みに失敗しました。ページを再読み込みしてください。<br>
                        <span class="font-mono">${String(msg).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;')}</span>`;
                }
                el.classList.remove('hidden');
            }
        }, 1500);
    </script>
</body>
</html>
